"use strict";import"@ui5/webcomponents-base/dist/ssr-dom.js";import w from"./thirdparty/merge.js";import{boot as O}from"./Boot.js";import U from"./UI5ElementMetadata.js";import S from"./EventProvider.js";import L from"./updateShadowRoot.js";import{shouldIgnoreCustomElement as F}from"./IgnoreCustomElements.js";import{renderDeferred as V,renderImmediately as N,cancelRender as j}from"./Render.js";import{registerTag as k,isTagRegistered as x,recordTagRegistrationFailure as $}from"./CustomElementsRegistry.js";import{observeDOMNode as H,unobserveDOMNode as z}from"./DOMObserver.js";import{skipOriginalEvent as q}from"./config/NoConflict.js";import B from"./locale/getEffectiveDir.js";import{kebabToCamelCase as I,camelToKebabCase as W}from"./util/StringHelper.js";import D from"./util/isValidPropertyName.js";import{getSlotName as K,getSlottedNodesList as G}from"./util/SlotsHelper.js";import b from"./util/arraysAreEqual.js";import{markAsRtlAware as J}from"./locale/RTLAwareRegistry.js";import Q from"./renderer/executeTemplate.js";import{attachFormElementInternals as X,setFormValue as P}from"./features/InputElementsFormSupport.js";let Y=0;const A=new Map,_=new Map;function y(f){this._suppressInvalidation||(this.onInvalidation(f),this._changedState.push(f),V(this),this._invalidationEventProvider.fireEvent("invalidate",{...f,target:this}))}function Z(f,M){do{const t=Object.getOwnPropertyDescriptor(f,M);if(t)return t;f=Object.getPrototypeOf(f)}while(f&&f!==HTMLElement.prototype)}class C extends HTMLElement{constructor(){super();const t=this.constructor;this._changedState=[],this._suppressInvalidation=!0,this._inDOM=!1,this._fullyConnected=!1,this._childChangeListeners=new Map,this._slotChangeListeners=new Map,this._invalidationEventProvider=new S,this._componentStateFinalizedEventProvider=new S;let e;if(this._domRefReadyPromise=new Promise(a=>{e=a}),this._domRefReadyPromise._deferredResolve=e,this._doNotSyncAttributes=new Set,this._state={...t.getMetadata().getInitialState()},this._upgradeAllProperties(),t._needsShadowDOM()){const a={mode:"open"};this.attachShadow({...a,...t.getMetadata().getShadowRootOptions()})}}get _id(){return this.__id||(this.__id=`ui5wc_${++Y}`),this.__id}render(){const t=this.constructor.template;return Q(t,this)}async connectedCallback(){const t=this.constructor;this.setAttribute(t.getMetadata().getPureTag(),""),t.getMetadata().supportsF6FastNavigation()&&this.setAttribute("data-sap-ui-fastnavgroup","true");const e=t.getMetadata().slotsAreManaged();this._inDOM=!0,e&&(this._startObservingDOMChildren(),await this._processChildren()),this._inDOM&&(N(this),this._domRefReadyPromise._deferredResolve(),this._fullyConnected=!0,this.onEnterDOM())}disconnectedCallback(){const e=this.constructor.getMetadata().slotsAreManaged();this._inDOM=!1,e&&this._stopObservingDOMChildren(),this._fullyConnected&&(this.onExitDOM(),this._fullyConnected=!1),this._domRefReadyPromise._deferredResolve(),j(this)}onBeforeRendering(){}onAfterRendering(){}onEnterDOM(){}onExitDOM(){}_startObservingDOMChildren(){const e=this.constructor.getMetadata();if(!e.hasSlots())return;const o=e.canSlotText(),s=Object.keys(e.getSlots()).some(c=>e.getSlots()[c].cloned),n={childList:!0,subtree:o||s,characterData:o};H(this,this._processChildren.bind(this),n)}_stopObservingDOMChildren(){z(this)}async _processChildren(){this.constructor.getMetadata().hasSlots()&&await this._updateSlots()}async _updateSlots(){const t=this.constructor,e=t.getMetadata().getSlots(),a=t.getMetadata().canSlotText(),o=Array.from(a?this.childNodes:this.children),s=new Map,n=new Map;for(const[i,m]of Object.entries(e)){const r=m.propertyName||i;n.set(r,i),s.set(r,[...this._state[r]]),this._clearSlot(i,m)}const c=new Map,d=new Map,l=o.map(async(i,m)=>{const r=K(i),u=e[r];if(u===void 0){if(r!=="default"){const h=Object.keys(e).join(", ");console.warn(`Unknown slotName: ${r}, ignoring`,i,`Valid values are: ${h}`)}return}if(u.individualSlots){const h=(c.get(r)||0)+1;c.set(r,h),i._individualSlot=`${r}-${h}`}if(i instanceof HTMLElement){const h=i.localName;if(h.includes("-")&&!F(h)){if(!customElements.get(h)){const T=customElements.whenDefined(h);let v=A.get(h);v||(v=new Promise(R=>setTimeout(R,1e3)),A.set(h,v)),await Promise.race([T,v])}customElements.upgrade(i)}}if(i=t.getMetadata().constructor.validateSlotValue(i,u),E(i)&&u.invalidateOnChildChange){const h=this._getChildChangeListener(r);h&&i.attachInvalidate.call(i,h)}i instanceof HTMLSlotElement&&this._attachSlotChange(i,r);const g=u.propertyName||r;d.has(g)?d.get(g).push({child:i,idx:m}):d.set(g,[{child:i,idx:m}])});await Promise.all(l),d.forEach((i,m)=>{this._state[m]=i.sort((r,u)=>r.idx-u.idx).map(r=>r.child)});let p=!1;for(const[i,m]of Object.entries(e)){const r=m.propertyName||i;b(s.get(r),this._state[r])||(y.call(this,{type:"slot",name:n.get(r),reason:"children"}),p=!0,t.getMetadata().isFormAssociated()&&P(this))}p||y.call(this,{type:"slot",name:"default",reason:"textcontent"})}_clearSlot(t,e){const a=e.propertyName||t;this._state[a].forEach(s=>{if(E(s)){const n=this._getChildChangeListener(t);n&&s.detachInvalidate.call(s,n)}s instanceof HTMLSlotElement&&this._detachSlotChange(s,t)}),this._state[a]=[]}attachInvalidate(t){this._invalidationEventProvider.attachEvent("invalidate",t)}detachInvalidate(t){this._invalidationEventProvider.detachEvent("invalidate",t)}_onChildChange(t,e){this.constructor.getMetadata().shouldInvalidateOnChildChange(t,e.type,e.name)&&y.call(this,{type:"slot",name:t,reason:"childchange",child:e.target})}attributeChangedCallback(t,e,a){let o;if(this._doNotSyncAttributes.has(t))return;const s=this.constructor.getMetadata().getProperties(),n=t.replace(/^ui5-/,""),c=I(n);if(s.hasOwnProperty(c)){const d=s[c],l=d.type;let p=d.validator;l&&l.isDataTypeClass&&(p=l),p?o=p.attributeToProperty(a):l===Boolean?o=a!==null:o=a,this[c]=o}}formAssociatedCallback(){this.constructor.getMetadata().isFormAssociated()&&X(this)}static get formAssociated(){return this.getMetadata().isFormAssociated()}_updateAttribute(t,e){const a=this.constructor;if(!a.getMetadata().hasAttribute(t))return;const s=a.getMetadata().getProperties()[t],n=s.type;let c=s.validator;const d=W(t),l=this.getAttribute(d);if(n&&n.isDataTypeClass&&(c=n),c){const p=c.propertyToAttribute(e);p===null?(this._doNotSyncAttributes.add(d),this.removeAttribute(d),this._doNotSyncAttributes.delete(d)):this.setAttribute(d,p)}else n===Boolean?e===!0&&l===null?this.setAttribute(d,""):e===!1&&l!==null&&this.removeAttribute(d):typeof e!="object"&&l!==e&&this.setAttribute(d,e)}_upgradeProperty(t){if(this.hasOwnProperty(t)){const e=this[t];delete this[t],this[t]=e}}_upgradeAllProperties(){this.constructor.getMetadata().getPropertiesList().forEach(this._upgradeProperty.bind(this))}_getChildChangeListener(t){return this._childChangeListeners.has(t)||this._childChangeListeners.set(t,this._onChildChange.bind(this,t)),this._childChangeListeners.get(t)}_getSlotChangeListener(t){return this._slotChangeListeners.has(t)||this._slotChangeListeners.set(t,this._onSlotChange.bind(this,t)),this._slotChangeListeners.get(t)}_attachSlotChange(t,e){const a=this._getSlotChangeListener(e);a&&t.addEventListener("slotchange",a)}_detachSlotChange(t,e){t.removeEventListener("slotchange",this._getSlotChangeListener(e))}_onSlotChange(t){y.call(this,{type:"slot",name:t,reason:"slotchange"})}onInvalidation(t){}_render(){const t=this.constructor,e=t.getMetadata().hasIndividualSlots();this._suppressInvalidation=!0,this.onBeforeRendering(),this._componentStateFinalizedEventProvider.fireEvent("componentStateFinalized"),this._suppressInvalidation=!1,this._changedState=[],t._needsShadowDOM()&&L(this),e&&this._assignIndividualSlotsToChildren(),this.onAfterRendering()}_assignIndividualSlotsToChildren(){Array.from(this.children).forEach(e=>{e._individualSlot&&e.setAttribute("slot",e._individualSlot)})}_waitForDomRef(){return this._domRefReadyPromise}getDomRef(){if(typeof this._getRealDomRef=="function")return this._getRealDomRef();if(!(!this.shadowRoot||this.shadowRoot.children.length===0))return this.shadowRoot.children[0]}getFocusDomRef(){const t=this.getDomRef();if(t)return t.querySelector("[data-sap-focus-ref]")||t}async getFocusDomRefAsync(){return await this._waitForDomRef(),this.getFocusDomRef()}async focus(t){await this._waitForDomRef();const e=this.getFocusDomRef();e&&typeof e.focus=="function"&&e.focus(t)}fireEvent(t,e,a=!1,o=!0){const s=this._fireEvent(t,e,a,o),n=I(t);return n!==t?s&&this._fireEvent(n,e,a,o):s}_fireEvent(t,e,a=!1,o=!0){const s=new CustomEvent(`ui5-${t}`,{detail:e,composed:!1,bubbles:o,cancelable:a}),n=this.dispatchEvent(s);if(q(t))return n;const c=new CustomEvent(t,{detail:e,composed:!1,bubbles:o,cancelable:a});return this.dispatchEvent(c)&&n}getSlottedNodes(t){return G(this[t])}attachComponentStateFinalized(t){this._componentStateFinalizedEventProvider.attachEvent("componentStateFinalized",t)}detachComponentStateFinalized(t){this._componentStateFinalizedEventProvider.detachEvent("componentStateFinalized",t)}get effectiveDir(){return J(this.constructor),B(this)}get isUI5Element(){return!0}get classes(){return{}}get accessibilityInfo(){return{}}static get observedAttributes(){return this.getMetadata().getAttributesList()}static _needsShadowDOM(){return!!this.template||Object.prototype.hasOwnProperty.call(this.prototype,"render")}static _generateAccessors(){const t=this.prototype,e=this.getMetadata().slotsAreManaged(),a=this.getMetadata().getProperties();for(const[o,s]of Object.entries(a)){if(D(o)||console.warn(`"${o}" is not a valid property name. Use a name that does not collide with DOM APIs`),s.type===Boolean&&s.defaultValue)throw new Error(`Cannot set a default value for property "${o}". All booleans are false by default.`);if(s.type===Array)throw new Error(`Wrong type for property "${o}". Properties cannot be of type Array - use "multiple: true" and set "type" to the single value type, such as "String", "Object", etc...`);if(s.type===Object&&s.defaultValue)throw new Error(`Cannot set a default value for property "${o}". All properties of type "Object" are empty objects by default.`);if(s.multiple&&s.defaultValue)throw new Error(`Cannot set a default value for property "${o}". All multiple properties are empty arrays by default.`);const n=Z(t,o);let c;n?.set&&(c=n.set);let d;n?.get&&(d=n.get),Object.defineProperty(t,o,{get(){if(d)return d.call(this);if(this._state[o]!==void 0)return this._state[o];const l=s.defaultValue;return s.type===Boolean?!1:s.type===String?l:s.multiple?[]:l},set(l){let p;const i=this.constructor;l=i.getMetadata().constructor.validatePropertyValue(l,s);const r=s.type;let u=s.validator;const g=d?d.call(this):this._state[o];r&&r.isDataTypeClass&&(u=r),u?p=!u.valuesAreEqual(g,l):Array.isArray(g)&&Array.isArray(l)&&s.multiple&&s.compareValues?p=!b(g,l):p=g!==l,p&&(c?c.call(this,l):this._state[o]=l,y.call(this,{type:"property",name:o,newValue:l,oldValue:g}),i.getMetadata().isFormAssociated()&&P(this),this._updateAttribute(o,l))}})}if(e){const o=this.getMetadata().getSlots();for(const[s,n]of Object.entries(o)){D(s)||console.warn(`"${s}" is not a valid property name. Use a name that does not collide with DOM APIs`);const c=n.propertyName||s;Object.defineProperty(t,c,{get(){return this._state[c]!==void 0?this._state[c]:[]},set(){throw new Error("Cannot set slot content directly, use the DOM APIs (appendChild, removeChild, etc...)")}})}}}static{this.metadata={}}static{this.styles=""}static get dependencies(){return[]}static getUniqueDependencies(){if(!_.has(this)){const t=this.dependencies.filter((e,a,o)=>o.indexOf(e)===a);_.set(this,t)}return _.get(this)||[]}static whenDependenciesDefined(){return Promise.all(this.getUniqueDependencies().map(t=>t.define()))}static async onDefine(){return Promise.resolve()}static async define(){await O(),await Promise.all([this.whenDependenciesDefined(),this.onDefine()]);const t=this.getMetadata().getTag(),e=x(t),a=customElements.get(t);return a&&!e?$(t):a||(this._generateAccessors(),k(t),customElements.define(t,this)),this}static getMetadata(){if(this.hasOwnProperty("_metadata"))return this._metadata;const t=[this.metadata];let e=this;for(;e!==C;)e=Object.getPrototypeOf(e),t.unshift(e.metadata);const a=w({},...t);return this._metadata=new U(a),this._metadata}get validity(){return this._internals?.validity}get validationMessage(){return this._internals?.validationMessage}checkValidity(){return this._internals?.checkValidity()}reportValidity(){return this._internals?.reportValidity()}}const E=f=>"isUI5Element"in f;export default C;export{E as instanceOfUI5Element};
//# sourceMappingURL=UI5Element.js.map
